# Caddyfile for Dicty Resolwe Server
# Serves frontend and proxies API to Django backend

{
    # Global options
    admin off
    # auto_https is enabled by default for domain names
}

# Main site - replace with your domain
:80, :443 {
    # Proxy API requests to Django backend (must come first)
    handle /api/* {
        reverse_proxy 127.0.0.1:8000
    }
    
    # Proxy admin requests to Django backend
    handle /admin/* {
        reverse_proxy 127.0.0.1:8000
    }
    
    # Proxy Django static files to backend
    handle /static/* {
        reverse_proxy 127.0.0.1:8000
    }
    
    # Serve frontend static files for everything else
    handle /* {
        root * /home/dictyapp/www/dicty
        try_files {path} {path}/ /index.html
        file_server
    }
    
    # Add security headers
    header {
        # Remove server info
        -Server
        # Security headers
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        # HSTS for HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
    
    # Compress responses
    encode gzip zstd
    
    # Logging
    log {
        output file /home/dictyapp/logs/caddy.log
        level INFO
    }
}
